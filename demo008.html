<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsPDF Text-Based Page Break Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            padding: 20px;
            background-color: #f9f9f9;
        }
        #content-container {
            max-width: 800px;
            margin: auto;
            border: 1px solid #ddd;
            padding: 40px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        h1, h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .page-break {
            /* This is the crucial style for our logic */
            page-break-before:always;
        }
        .button-container {
            text-align: center;
            margin-top: 30px;
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <div id="content-container">
        <!-- ===== PAGE 1 CONTENT ===== -->
        <h1>Quarterly Business Review</h1>
        <p>This document provides a comprehensive overview of the company's performance in the last quarter. We will cover <strong>key financial metrics</strong>, departmental updates, and strategic initiatives for the upcoming quarter. This first section serves as an executive summary.</p>
        <p>Overall, the results were positive, with a notable <em>15% increase in revenue</em> compared to the previous quarter. This growth was primarily driven by the successful launch of our new product line.</p>

        <!-- Page Break Here -->
        <div class="page-break" style="page-break-before:always;"></div>

        <!-- ===== PAGE 2 CONTENT ===== -->
        <h2>Financial Performance Details</h2>
        <p>The financial results reflect a strong market position. Here is a breakdown of the key figures. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor. Cras elementum ultrices diam.</p>
        <p>The operating margin improved by 2%, and we saw a significant reduction in customer acquisition costs. <b>This is a testament to our improved marketing efficiency.</b> Maecenas ligula massa, varius a, semper congue, euismod non, mi. Proin porttitor, orci nec nonummy molestie, enim est eleifend mi, non fermentum diam nisl sit amet erat.</p>

        <!-- Page Break Here -->
        <div class="page-break" style="page-break-before:always;"></div>

        <!-- ===== PAGE 3 CONTENT ===== -->
        <h2>Outlook and Future Strategy</h2>
        <p>Looking ahead, our focus will be on international expansion and further product innovation. We have identified several key markets for growth and will be allocating resources accordingly.</p>
        <p>We are confident that by continuing to execute on our strategic plan, we will deliver strong results in the next quarter. The team is aligned and motivated to achieve our goals. <i>Thank you for your continued dedication.</i></p>
    </div>

    <div class="button-container">
        <button onclick="runTextPdfGenerator()">Generate Selectable PDF</button>
    </div>

    <!-- Include jsPDF library from a CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      /**
       * Renders HTML content into a text-based, selectable PDF, respecting page breaks.
       * This function parses the DOM and uses native jsPDF methods to draw text and elements.
       *
       * @param {HTMLElement} element The source HTML element.
       * @param {object} [options] Configuration options.
       * @param {string} [options.filename='text-document.pdf'] The name for the downloaded PDF.
       * @param {object} [options.jsPDF] jsPDF constructor options.
       */
      function generateTextPdfWithPageBreaks(element, options = {}) {
        const {
          filename = 'text-document.pdf',
          jsPDF: jsPDFOptions = { orientation: 'p', unit: 'mm', format: 'a4' },
        } = options;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(jsPDFOptions);

        const leftMargin = 15;
        const topMargin = 20;
        const rightMargin = 15;
        const bottomMargin = 20;
        const page = doc.internal.pageSize;
        const pageWidth = page.getWidth();
        const pageHeight = page.getHeight();
        const usableWidth = pageWidth - leftMargin - rightMargin;
        let currentY = topMargin;

        const lineHeight = doc.getLineHeight() / doc.internal.scaleFactor;

        function addPageIfNeeded(elementHeight = 0) {
          if (currentY + elementHeight > pageHeight - bottomMargin) {
            doc.addPage();
            currentY = topMargin;
          }
        }

        function renderNode(node) {
          switch (node.nodeType) {
            case Node.ELEMENT_NODE:
              const tagName = node.tagName.toUpperCase();
              doc.saveGraphicsState();
              let addMargin = 0;
              let isList = false;

              switch (tagName) {
                case 'H1':
                  doc.setFont(undefined, 'bold');
                  doc.setFontSize(22);
                  addMargin = 8;
                  break;
                case 'H2':
                  doc.setFont(undefined, 'bold');
                  doc.setFontSize(16);
                  addMargin = 6;
                  break;
                case 'P':
                  doc.setFont(undefined, 'normal');
                  doc.setFontSize(11);
                  addMargin = 5;
                  break;
                case 'B': case 'STRONG':
                  doc.setFont(undefined, 'bold');
                  break;
                case 'I': case 'EM':
                  doc.setFont(undefined, 'italic');
                  break;
              }

              if (addMargin > 0) {
                currentY += addMargin;
                addPageIfNeeded();
              }
              
              node.childNodes.forEach(child => renderNode(child));
              
              if (addMargin > 0) currentY += addMargin / 2;
              doc.restoreGraphicsState();
              break;

            case Node.TEXT_NODE:
              const text = node.nodeValue.trim();
              if (text) {
                const lines = doc.splitTextToSize(text, usableWidth);
                const textHeight = lines.length * lineHeight;
                
                addPageIfNeeded(textHeight);
                
                doc.text(lines, leftMargin, currentY);
                currentY += textHeight;
              }
              break;
          }
        }

        const chunks = [];
        let currentChunk = document.createElement('div');
        const sourceClone = element.cloneNode(true);

        sourceClone.childNodes.forEach(child => {
          if (child.nodeType === Node.ELEMENT_NODE && getComputedStyle(child).pageBreakBefore === 'always') {
            if (currentChunk.childNodes.length > 0) chunks.push(currentChunk);
            currentChunk = document.createElement('div');
          } else {
            currentChunk.appendChild(child.cloneNode(true));
          }
        });
        chunks.push(currentChunk);

        chunks.forEach((chunk, index) => {
          if (index > 0) {
            doc.addPage();
            currentY = topMargin;
          }
          chunk.childNodes.forEach(node => renderNode(node));
        });

        doc.save(filename);
      }

      function runTextPdfGenerator() {
        const element = document.getElementById('content-container');
        generateTextPdfWithPageBreaks(element);
      }
    </script>

</body>
</html>